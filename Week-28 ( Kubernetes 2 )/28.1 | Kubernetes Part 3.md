# 28.1 | Kubernetes Part 3

To run a Kubernetes (k8s) cluster on a cloud provider like AWS, GCP, DigitalOcean, or Vultr, follow these steps. The instructions will cover creating a cluster, configuring your local environment, and deploying an application.

### 1. **AWS (Amazon Web Services)**

#### Create a Kubernetes Cluster with EKS (Elastic Kubernetes Service)
1. **Sign in to AWS Management Console**:
   - Navigate to the EKS service.
   - Click "Create cluster".
   - Configure your cluster name, role, networking, and logging.
   - Create the cluster and wait for it to become active.

2. **Install AWS CLI and eksctl**:
   - AWS CLI: [Installation guide](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)
   - eksctl: [Installation guide](https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html)

3. **Create EKS Cluster using eksctl**:
   ```sh
   eksctl create cluster --name my-cluster --region us-west-2 --nodegroup-name my-nodes --node-type t2.micro --nodes 3
   ```

4. **Configure kubectl**:
   ```sh
   aws eks --region us-west-2 update-kubeconfig --name my-cluster
   ```

### 2. **GCP (Google Cloud Platform)**

#### Create a Kubernetes Cluster with GKE (Google Kubernetes Engine)
1. **Sign in to Google Cloud Console**:
   - Navigate to the GKE service.
   - Click "Create cluster".
   - Configure your cluster name, location, and node settings.
   - Create the cluster.

2. **Install Google Cloud SDK**:
   - [Installation guide](https://cloud.google.com/sdk/docs/install)

3. **Initialize the SDK and configure kubectl**:
   ```sh
   gcloud init
   gcloud container clusters get-credentials my-cluster --zone us-central1-a --project my-project
   ```

### 3. **DigitalOcean**

#### Create a Kubernetes Cluster with DigitalOcean Kubernetes (DOKS)
1. **Sign in to DigitalOcean Console**:
   - Navigate to the Kubernetes service.
   - Click "Create a Kubernetes Cluster".
   - Configure your cluster name, region, and node pool.
   - Create the cluster.

2. **Install doctl**:
   - [Installation guide](https://docs.digitalocean.com/reference/doctl/how-to/install/)

3. **Download kubeconfig**:
   ```sh
   doctl kubernetes cluster kubeconfig save my-cluster
   ```

### 4. **Vultr**

#### Create a Kubernetes Cluster with Vultr Kubernetes Engine (VKE)
1. **Sign in to Vultr Console**:
   - Navigate to the Kubernetes service.
   - Click "Deploy Cluster".
   - Configure your cluster name, region, and node pool.
   - Deploy the cluster.

2. **Download kubeconfig**:
   - Navigate to your cluster details.
   - Download the kubeconfig file.

### Replace `~/.kube/config` with the Credentials File
Download the credentials file from the respective cloud provider and replace your local kubeconfig:
```sh
mv path-to-downloaded-kubeconfig ~/.kube/config
```

### Create a Deployment Manifest
Create a file named `deployment.yml` with the following content:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
```

### Create the Deployment
Run the following command to apply the deployment manifest:
```sh
kubectl apply -f deployment.yml
```

This sequence will help you create a Kubernetes cluster on any of these cloud providers, configure your local environment, and deploy an NGINX application.

To expose your app over the internet using Kubernetes Services, you can create either a NodePort or a LoadBalancer service. Below are the steps to create both types of services and access your application.

### 1. **NodePort Service**

A NodePort service exposes the application on a specific port on each node in the cluster.

#### Create a NodePort Service (service.yml)
Create a file named `service.yml` with the following content:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30007  # This port can be any valid port within the NodePort range
  type: NodePort
```

#### Apply the NodePort Service
Run the following command to apply the service manifest:

```sh
kubectl apply -f service.yml
```

#### Access the Application
Visit any of the nodes on port 30007. If you’re running Kubernetes locally (e.g., with `kind`), you can visit:

```sh
http://localhost:30007/
```

### 2. **LoadBalancer Service**

A LoadBalancer service is designed to work with cloud providers to create an external load balancer that routes traffic to the service.

#### Create a LoadBalancer Service
Modify `service.yml` to use the `LoadBalancer` type:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: LoadBalancer
```

#### Apply the LoadBalancer Service
Run the following command to re-apply the service manifest:

```sh
kubectl apply -f service.yml
```

#### Access the Application
1. **Check the LoadBalancer IP**:
   After applying the LoadBalancer service, it may take a few minutes for the external IP to be assigned. You can check the status using:

   ```sh
   kubectl get services
   ```

   Look for the `EXTERNAL-IP` field for your `nginx-service`.

2. **Visit the LoadBalancer IP**:
   Once the external IP is available, you can visit it in your browser:

   ```sh
   http://<external-ip>
   ```

### Notes
- **Vultr Specific**: For Vultr, the LoadBalancer service will automatically work with Vultr’s cloud load balancer setup.
- **Local Development with kind**: If you are using `kind` for local Kubernetes, ensure you start the kind cluster with the appropriate configuration to support NodePort. For LoadBalancer, a cloud environment is required.

By following these steps, you can expose your application over the internet using either NodePort or LoadBalancer services in Kubernetes. This allows external traffic to reach your application running in the Kubernetes cluster.